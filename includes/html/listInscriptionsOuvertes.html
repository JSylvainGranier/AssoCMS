<h1>Inscriptions Ouvertes</h1>

$adminForOtherFamilies$

<p style="display : $displayCreateAccountParapgraph$;">

Pour utiliser les inscriptions en ligne, il faut d'abord que l'on sache qui vous êtes <i class="fa fa-smile-o" aria-hidden="true"></i> !

<br />
<br />

Si vous êtes déjà membre de $site_title$, vous devez simplement vous identifier avec votre adresse email et votre mot de passe. <br />
Fermez les yeux, et glissez jusqu'au bas de cette page jusqu'à arriver au formulaire de connexion habituel. 

<br />
<br />

Pour les nouveaux adhérents qui souhaitent rejoindre notre association, et seulement dans ce cas-là, vous devez d'abord renseigner les informations d'état civil, et ensuite vous inscrire dans la foulée. 

<br />
<br />

Si vous rencontrez des difficultés pour vous inscrire, vous pouvez nous adresser votre demande par email. 

</p>


<style>
	button[notchecked] {
		background-color: red;
		font-size: 1.5em;
	}
	
	button[notchecked]::after {
		content : "Cliquez ici pour consulter et accepter les conditions spécifiques";
	}
	
	.startValidatingConditionsButton {
		border : solid 3px green;
	}
	
	 .modal {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transform: scale(1.1);
        transition: visibility 0s linear 0.25s, opacity 0.25s 0s, transform 0.25s;
    }
    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 1rem 1.5rem;
        width: 80%;
        max-height : 80%;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .modal-scrollable-body {
		height : 75vh;
    	overflow: auto;
    }
    
    .modal-foot {
		height : 5vh;
		text-align: center;
    }
    
    .modal-foot button {
    	margin-top : 15px;
    	font-size: 1.5em;
    	
    }
    .close-button {
        float: right;
        width: 1.5rem;
        line-height: 1.5rem;
        text-align: center;
        cursor: pointer;
        border-radius: 0.25rem;
        background-color: lightgray;
    }
    .close-button:hover {
        background-color: darkgray;
    }
    .show-modal {
        opacity: 1;
        visibility: visible;
        transform: scale(1.0);
        transition: visibility 0s linear 0s, opacity 0.25s 0s, transform 0.25s;
    }

</style>

<div id="produitListContainer">
	
</div>

<div id="summaryContainer">
	
</div>

<div class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-scrollable-body"></div>
            <div class="modal-foot"><button onclick="acceptConditions(this.target)">J'accepte ces conditions</button></div>
        </div>
</div>

<template id="produitTemplate">
	<div class="produitContainer">
		<h2 produitTitre></h2>
		<div produitDescription>
		</div>
		<div>
		J'inscris : 
			<ul produitPersonnesAInscrire>
			</ul>
		</div>
		<div produitConditions>
		</div>
	</div>
</template>
<script src="ressources/moment-with-locales.js"></script>
<script>

window.uidCounter = 0;
window.uniqueId = function(){
    return 'myid-' + window.uidCounter++
}

var renderProduitList = function(){
	var pListContainer = document.getElementById("produitListContainer");
	var produitTemplate = document.querySelector("#produitTemplate");
	
	for (var prod in config.produits) {
	    if (Object.prototype.hasOwnProperty.call(config.produits, prod)) {
	    	var produit = config.produits[prod];
	    	if(!produit.accesDirect){
				continue;
			}
		
			var clone = document.importNode(produitTemplate.content, true);
			clone.querySelector("h2[produitTitre]").innerHTML = produit.libelle;
			clone.querySelector("div[produitDescription]").innerHTML = produit.description;

			
			
			var listPersonnes = clone.querySelector("ul[produitPersonnesAInscrire]");
			listPersonnes.setAttribute("idProduit", produit.idProduit);
			
			var quantiteLieAPersonneEacherator = function(personne){
				var persCbx = document.createElement("LI");
				persCbx.innerHTML = "<label><input type='checkbox' name='produitPersonneCbx' value='"+personne.idPersonne+"' idproduit='"+produit.idProduit+"' idproduitrequis='"+produit.produitRequis+"'/> "+personne.prenom+" "+personne.nom+"</label>";
				persCbx.onchange = function(e){
					var inscriptionEtInscriptionProduit = findOrCreateInscriptionForProduit(e.target.value, parseInt(e.target.getAttribute("idproduit")));
					inscriptionEtInscriptionProduit.quantite = e.target.checked ? 1 : 0;
					
					if(e.target.getAttribute("idproduitrequis") !== 'undefined'){
						var produitRequisSouscription = findOrCreateInscriptionForProduit(e.target.value, parseInt(e.target.getAttribute("idproduitrequis")));
						produitRequisSouscription.quantite += e.target.checked ? 1 : -1;
					}
					
					willUpdateSummary();
					
				}
				
				listPersonnes.appendChild(persCbx);
			};
			
			var quantiteLibreEacherator = function(personne){
				var persCbx = document.createElement("LI");
				persCbx.innerHTML = "<label><input type='checkbox' name='produitPersonneCbx' value='"+personne.idPersonne+"' idproduit='"+produit.idProduit+"' idproduitrequis='"+produit.produitRequis+"'/> "+personne.prenom+" "+personne.nom+"</label>";
				persCbx.onchange = function(e){
					var inscriptionEtInscriptionProduit = findOrCreateInscriptionForProduit(e.target.value, parseInt(e.target.getAttribute("idproduit")));
					inscriptionEtInscriptionProduit.quantite = e.target.checked ? 1 : 0;
					
					if(e.target.getAttribute("idproduitrequis") !== 'undefined'){
						var produitRequisSouscription = findOrCreateInscriptionForProduit(e.target.value, parseInt(e.target.getAttribute("idproduitrequis")));
						produitRequisSouscription.quantite += e.target.checked ? 1 : -1;
					}
					
					willUpdateSummary();
					
				}
				
				listPersonnes.appendChild(persCbx);
			};
			
			
			
			config.famille.members.forEach(prod.quantiteLibre ? quantiteLibreEacherator : quantiteLieAPersonneEacherator);
			
			if(produit.conditionsLegales && produit.conditionsLegales.length > 5){
				var condContainer = clone.querySelector("div[produitConditions]");
				
				condContainer.innerHTML = "<button class='startValidatingConditionsButton' onclick='startValidatingConditions("+produit.idProduit+", this.target)' notchecked idproduit='"+produit.idProduit+"'>Conditions particulières</button>";				
			}

			
			
			pListContainer.appendChild(clone);
	    }
	}
	

}




var modal = document.querySelector(".modal");
var closeButton = document.querySelector(".close-button");

function toggleModal() {
    modal.classList.toggle("show-modal");
}

function windowOnClick(event) {
    if (event.target === modal) {
        toggleModal();
    }
}

closeButton.addEventListener("click", toggleModal);
window.addEventListener("click", windowOnClick);


var startValidatingConditions = function(idProduit, button){
	
	document.querySelector(".modal-scrollable-body").innerHTML = config.produits[idProduit].conditionsLegales;
	
	document.querySelector(".modal-foot").querySelector("button").setAttribute("idproduit", idProduit);
	
	
	
	toggleModal();
}

var acceptConditions = function(button){
	var idProduit = parseInt(document.querySelector(".modal-foot").querySelector("button").getAttribute("idproduit"));
	
	var q = "button[idproduit='"+idProduit+"'].startValidatingConditionsButton";
	console.log(q);
	
	document.querySelector(q).removeAttribute("notchecked");
	
	if(!config.conditionsAcceptees){
		config.conditionsAcceptees = new Array();
	}
	
	config.conditionsAcceptees[idProduit] = document.querySelector(".modal-scrollable-body").innerHTML;
	
	toggleModal();
}

var findOrCreateInscriptionForProduit = function(idPersonne, idProduit){
	//parmis config.currentInscription, retourner ou créer, ajouter et retourner un objet qui corresponde à l'inscription de idPersonne au produit idProduit. 
	//En ayant populé les autres champs. 
	
	var candidat = null;
	
	config.inscriptionPersonneProduit[config.currentInscription.idInscription].forEach(function(inscr){
		if(inscr.idProduit == idProduit &&  inscr.idPersonne == idPersonne && inscr.idInscription == config.currentInscription.idInscription){
    		candidat = inscr;
    	}
	});
	
	console.log(idPersonne, idProduit, "found ", candidat);
	
	
	if (candidat == null){
		candidat = {
			uniqueId : window.uniqueId(),
			idProduit : idProduit,
			idPersonne : idPersonne,
			idInscription : config.currentInscription.idInscription,
			quantite : 0
		}
		config.inscriptionPersonneProduit[config.currentInscription.idInscription].push(candidat);
		//config.inscriptions[candidat.uniqueId] = candidat;
	}
	
	return candidat;
	
	//Et plus tard, en ayant rajouté les produits dépendants, et les règlements dépendants. 
}

var willUpdateSummaryTimer = null;
var willUpdateSummary = function(){
	if (willUpdateSummaryTimer != null){
		clearTimeout(willUpdateSummaryTimer);
	}
	
	willUpdateSummaryTimer = setTimeout(updateSummary, 250);
}
var updateSummary = function(){
	
	config.ticket = new Array();
	var targetCnt = document.getElementById("summaryContainer");
	targetCnt.innerHTML = "";
	
	config.inscriptionPersonneProduit[config.currentInscription.idInscription].forEach(function(souscription){
		
		if(souscription.quantite > 0 && config.produits[souscription.idProduit].politiqueTarifaire){
			var reponsePolitiqueTarifaire = config.produits[souscription.idProduit].politiqueTarifaire(souscription);
			
			if(Array.isArray(reponsePolitiqueTarifaire)){
				config.ticket = config.ticket.concat(reponsePolitiqueTarifaire);
			} else {
				config.ticket.push(reponsePolitiqueTarifaire);
			}
			
		}
		
	});
	
	config.ticket.forEach(function(tl){
		if(tl.quantite == 0){
			return;
		}
		if(tl){
			var ligne = document.createElement("DIV");
			ligne.innerHTML = tl.libelle + " " + tl.quantite + " x " + tl.prixUnitaire + " = " + (tl.quantite * tl.prixUnitaire) + "€ + (le "+moment(tl.dateEcheance).format("DD/MM/YYYY")+")";
			
			targetCnt.append(ligne);
		}
		
		
	});
}


var initPolitiqueTarifaireFunction = function(){
	
	config.famille.members.forEach(function(personne){ personne.age = moment().diff(personne.dateNaissance, 'years' ) });
	
	try {
		
		for (var prod in config.produits) {
		    if (Object.prototype.hasOwnProperty.call(config.produits, prod)) {
		    	var produit = config.produits[prod];
		
			
				if(produit.politiqueTarifaire && produit.politiqueTarifaire.length > 15){
					var politique =  produit.politiqueTarifaire
					if({}.toString.call(politique) === '[object String]'){
						eval(" politique = function(souscription){ try{ "+politique+" } catch(e) {console.log(e); errorSurPolitiqueTarifaire("+produit.idProduit+")} } ;");
						
						produit.politiqueTarifaire = politique;
					}
				}
			
		    }
	    };
	} catch (e){
		alert("Erreur en initializant les politiques tarifaires des produits.");
		console.log(e);
	}
	
	
	
	
	
	
}

var errorSurPolitiqueTarifaire = function(idProduit){
	alert("Erreur en appliquant la politique tarifaire du produit "+idProduit);
}

var config = $config$;

initPolitiqueTarifaireFunction();

renderProduitList();

var findPersonneById = function(idPersonne){
	return config.famille.members.filter(p => p.idPersonne == idPersonne)[0];
}

var politiqueTarifaireFixeALaSouscription = function(souscription,libelle, prixUnitaire){
	return {
		libelle : libelle, 
		quantite : souscription.quantite, 
		prixUnitaire : prixUnitaire, 
		idProduit : souscription.idProduit,
		idPersonne : souscription.idPersonne,
		dateEcheance : moment().format("YYYY-MM-DD"), 
		uniqueId : souscription.uniqueId
	}
}

var politiqueAdhesionAssociation = function(souscription, pol){
	//{premierAdulte : 22, autresAdultes : 16, adoSeul : 13, enfant : 3, ageMaxEnfant :   15, ageMaxAdo : 20};
	
	var personneCourante = findPersonneById(souscription.idPersonne);
	
	
	
	if(personneCourante == null)
		throw new Exception("Je n'ai pas trouvé la personne courante en appliquant les tarifs de l'adhésion... ");
	
	var premierAdulteDejaLa = false;
	
	
	var rep = {
			libelle : "Quoi ?", 
			quantite : 1, 
			prixUnitaire : 666, 
			idProduit : souscription.idProduit,
			idPersonne : souscription.idPersonne,
			dateEcheance : moment().format("YYYY-MM-DD"), 
			uniqueId : souscription.uniqueId
		};
	
	config.ticket.forEach(function(ticket){
		if(ticket.idProduit == souscription.idProduit){
			var personneDejaSurProduit = findPersonneById(ticket.idPersonne); 
			

			if(personneDejaSurProduit && personneDejaSurProduit.age > pol.ageMaxAdo && personneDejaSurProduit.idPersonne != souscription.idProduit){
				premierAdulteDejaLa = personneDejaSurProduit;
			}
		}
	});
	
	if(personneCourante.age > pol.ageMaxAdo){
		//Adulte : 
		if(premierAdulteDejaLa){
			rep.libelle = "Adhésion à l'association pour un adulte supplémentaire";
			rep.prixUnitaire = pol.autresAdultes;
		} else {
			rep.libelle = "Adhésion à l'association pour le premier adulte";
			rep.prixUnitaire = pol.premierAdulte;
		}
	} else if (premierAdulteDejaLa == false && personneCourante.age > pol.ageMaxEnfant) {
		rep.libelle = "Adhésion à l'association pour un adolescent seul";
		rep.prixUnitaire = pol.adoSeul;
	} else if (premierAdulteDejaLa && personneCourante.age <= pol.ageMaxEnfant){
		rep.libelle = "Adhésion à l'association pour un enfant";
		rep.prixUnitaire = pol.enfant;
	} else {
		throw "Impossible de trouver un tarif pour votre situation";
	}
	
	return rep;
	
}

var politiqueTarifaireFixeALaSouscriptionSelonAge = function(souscription, pol){
	// {tarifAdulte : 13, tarifEnfant : 7, ageMaxEnfant : 16, libelle : "Assurance Randonnée" } 
	var personneCourante = findPersonneById(souscription.idPersonne);
	
	if(personneCourante == null)
		throw new Exception("Je n'ai pas trouvé la personne courante en appliquant les tarifs de l'adhésion... ");
	
	var rep = {
		libelle : pol.libelle, 
		quantite : 1, 
		prixUnitaire : 666, 
		idProduit : souscription.idProduit,
		idPersonne : souscription.idPersonne,
		dateEcheance : moment().format("YYYY-MM-DD"), 
		uniqueId : souscription.uniqueId
	}
	
	if(personneCourante.age > pol.ageMaxEnfant){
		rep.prixUnitaire = pol.tarifAdulte;
	} else {
		rep.prixUnitaire = pol.tarifEnfant;
		rep.libelle += " (enfant)";
	}
	
	return rep;
}

var politiqueTarifaireMensuelle = function(souscription, pol ){
	//{jourDuMois : 30, debut : "2020-10-01", fin : "2021-07-1", libelle : "Participation Mensuelle Poterie", tarif1 : 33, ageMaxTarif1 : 16, tarif2 : 48}

	var personneCourante = findPersonneById(souscription.idPersonne);
	
	var start = moment(pol.debut).startOf('month').add(pol.jourDuMois-1, 'day');
	var end = moment(pol.fin);
	
	var reps = [];
	
	do {
		
		var rep = {
				libelle : pol.libelle, 
				quantite : 1, 
				prixUnitaire : personneCourante.age <= pol.ageMaxTarif1 ? pol.tarif1 : pol.tarif2, 
				idProduit : souscription.idProduit,
				idPersonne : souscription.idPersonne,
				dateEcheance : start.clone(), 
				uniqueId : souscription.uniqueId
		}
		
		reps.push(rep);
		
		start = start.add(1, 'month').startOf('month');
		var daysToAdd = start.daysInMonth() < pol.jourDuMois ? start.daysInMonth() : pol.jourDuMois;
		start = start.add(daysToAdd-1, 'day');
		
	} while (!start.isAfter(end));
	
	return reps;
}


</script>